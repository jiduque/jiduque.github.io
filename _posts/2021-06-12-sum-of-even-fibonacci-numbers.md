---
title: Sum of Even Fibonacci Numbers
author: Jorge Duque
date: 2020-06-12 
categories: [Math, Project Euler]
math: true
mermaid: false
---

**Note: This is problem 2 on Project Euler**

# Problem Statement 


Each new term in the Fibonacci sequence is generated by adding the previous two terms. By starting with 1 and 2, the first 10 terms will be:

$$ 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, ... $$

By considering the terms in the Fibonacci sequence whose values do not exceed four million, find the sum of the even-valued terms.


# Solution(s)

I will explain how you can do this in two ways. One is obvious and the other is a little more involved, but it  allows you to get constant time complexity. The operations done in the constant time solution are a bit expensive so in practice, they run in about the same time. My Python implementation of both solutions can be found <a href="https://github.com/jiduque/project-euler/blob/main/Problem2.py" target="_blank">here </a>.

## Simple Solution
The simple solution to this problem is to just generate the Fibonacci numbers less than four million, and add the even ones to a running sum. Because the Fibonacci sequence grows exponentially, this solution is actually efficient (logarithmic time). But we can actually solve this problem in constant time using <a href="https://en.wikipedia.org/wiki/Generating_function" target="_blank">generating functions</a>, the <a href="https://en.wikipedia.org/wiki/Geometric_series" target="_blank">geometric series</a>, and a pattern about the parity of the Fibonacci numbers. 

## Generating Functions
Using generating functions, we can find a formula to get the $n^{th}$ Fibonacci number that is only dependent on $n$ and isn't recursive. I won't show how to use them to get the formula for the Fibonacci numbers, but if you're interested, you can see how in <a href="https://www.austinrochford.com/posts/2013-11-01-generating-functions-and-fibonacci-numbers.html" target="_blank"> this post </a> by Austin Rochford. The generating function for the Fibonacci sequence is shown below: 

$$ F_n =  \frac{1}{\sqrt{5}} \left( \phi^n - \psi^n \right) $$

where $\phi$ is the golden ratio and $\psi$ is the silver ratio. This can be somewhat surprising because all of the terms in it are irrational and it gives an integer, but it works.   


## Even Fibonacci Numbers
We now have an efficient way to generate Fibonacci numbers at will, but how do we know which ones are even? Better yet, how do we generate only the even Fibonacci numbers. Let's take a look at the sequence one more time.

$$1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, ... $$

Let's change the sequence to a sequence of their parity.

$$o, o, e, o, o, e, o, o, e, o, o, ... $$

It is now clear that every third number is even. Which means we can generate the $k^{th}$ even Fibonacci number with the following formula:

$$ E_k =  \frac{1}{\sqrt{5}} \left( \phi^{3k} - \psi^{3k} \right) $$


## Adding it Up
The value we are actually looking for is the sum of these numbers until the final term is the last Fibonacci number below some given number, $N$. Let's call the solution $S$ and for now we assume we know what the index of that Fibonacci number is and will call it $B$ (for bound). Now let's add all the even Fibonacci numbers up to $B$.

$$S = \sum_{i=0}^{B}E_{i} = \sum_{i=0}^{B}\frac{1}{\sqrt{5}} \left( \phi^{3i} - \psi^{3i} \right) = \frac{1}{\sqrt{5}} \left[ \sum_{i=0}^{B} (\phi^{3})^i - \sum_{i=0}^{B} (\psi^{3})^i  \right]$$

Now we can use the closed form version of the geometric series and get the following formula below.

$$S = \frac{1}{\sqrt{5}} \left[ \frac{1 - \phi^{3(B+1)}}{1 - \phi^{3}}  - \frac{1 - \psi^{3(B+1)}}{1 - \psi^{3}}\right]$$

## Upper Bound
We are almost done! All we are missing is what the value of $B$ actually is. Fortunately, that part is pretty straight forward. All we do is solve the following inequality:

$$E_k \leq N < E_{k+1}$$

$$\frac{1}{\sqrt{5}} \left( \phi^{3k} - \psi^{3k} \right) \leq N < \frac{1}{\sqrt{5}} \left( \phi^{3(k+1)} - \psi^{3(k+1)} \right)$$

This thing is trancendental, which means we won't we able to solve for $k$ exactly. But one thing to notice is that, because the magnitude of $\psi$ is less than one, as $k$ gets large, $\psi^k \to 0$. Better for us is that we are raising $\psi^3$ to the $k$ so it goes to 0 even faster. This means that for large $k$ we can simplify the inequality to the one below.


$$\frac{1}{\sqrt{5}} \phi^{3k} \leq N < \frac{1}{\sqrt{5}} \phi^{3(k+1)}$$

which gives the following result:

$$k \leq \frac{\log \sqrt{5}N}{ \log \phi^3}  < k+1$$

For our code, this means we use the expression in the inequality to estimate our bound. We can check if the next even Fibonacci number is less than $N$ and then update the bound. For small $N$ our initial estimate will be off, but as $N$ increases, our estimate will be good and pretty much exact. 